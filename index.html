<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3076/3076092.png"> <title>TBA360 æˆ°æƒ…å®¤</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            background: #000; color: #fff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 20px; padding-top: 50px; /* é¿é–‹ç€æµ· */
            min-height: 100vh; margin: 0; box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        .pixel-box { 
            border: 2px solid #fff; padding: 20px; margin-bottom: 20px; 
            width: 100%; max-width: 500px; box-sizing: border-box; 
            background: #111; border-radius: 12px; /* æ‰‹æ©Ÿä¸Šåœ“è§’æ¯”è¼ƒå¥½çœ‹ */
            box-shadow: 0 4px 10px rgba(0,242,255,0.1);
        }

        .timer-val { font-size: 3rem; color: #39ff14; text-align: center; margin: 10px 0; font-weight: bold; font-family: monospace; }
        
        .xp-bg { width: 100%; height: 12px; background: #333; border-radius: 6px; margin-bottom: 10px; overflow: hidden; }
        #xpBar { height: 100%; background: linear-gradient(90deg, #00f2ff, #00aaff); width: 0%; transition: 0.5s; }
        
        /* è¡¨å–®å„ªåŒ–ï¼šæ›´å¥½æŒ‰ */
        input, select, textarea { 
            width: 100%; background: #222; border: 1px solid #555; color: #fff; 
            padding: 12px; margin-top: 10px; box-sizing: border-box; 
            border-radius: 8px; font-size: 16px; /* é˜²æ­¢ iOS è‡ªå‹•æ”¾å¤§ */
        }
        
        button { 
            width: 100%; margin-top: 15px; padding: 15px; background: #fff; color: #000; 
            border: none; cursor: pointer; font-weight: bold; font-size: 1.1rem; 
            border-radius: 8px; transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); background: #ddd; }
        
        .log-item { border: 1px solid #333; padding: 15px; margin-top: 10px; background: #1a1a1a; border-radius: 8px; }
        .log-img { width: 100%; max-height: 300px; object-fit: cover; border-radius: 6px; margin: 10px 0; }
        
        .mgmt-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .s-btn { flex: 1; padding: 8px; font-size: 0.9rem; background: #333; color: #ccc; border-radius: 6px; border: 1px solid #444; }
        
        /* éš±è—æ²è»¸ */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body>

    <div class="pixel-box">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span id="lvDisplay" style="color:#00f2ff; font-weight:bold;">Lv.1 é¨å£«</span>
            <span style="font-size:0.8rem; color:#aaa;">2026/11/13 ç›®æ¨™</span>
        </div>
        <div class="xp-bg"><div id="xpBar"></div></div>
        <div class="timer-val" id="timerDisp">---</div>
        <div class="mgmt-btns">
            <button onclick="exportData()" class="s-btn">ğŸ’¾ å‚™ä»½</button>
            <button onclick="document.getElementById('importFile').click()" class="s-btn">ğŸ“‚ é‚„åŸ</button>
        </div>
        <input type="file" id="importFile" style="display:none" onchange="importData(event)">
    </div>

    <div class="pixel-box" id="formBox">
        <h2 id="formTitle" style="margin-top:0; border-bottom:1px solid #333; padding-bottom:10px;">â¤ å¯«å…¥ç´€éŒ„</h2>
        <form id="mainForm">
            <input type="hidden" id="editIdx" value="-1">
            <input type="date" id="f_date" required>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <select id="f_knee">
                    <option value="ğŸŸ¢èˆ’æœ">ğŸŸ¢ èˆ’æœ</option>
                    <option value="ğŸŸ¡å¾®é…¸">ğŸŸ¡ å¾®é…¸</option>
                    <option value="ğŸ”´ç–¼ç—›">ğŸ”´ ç–¼ç—›</option>
                </select>
                <input type="number" id="f_sleep" placeholder="ç¡çœ  (0-100)">
            </div>
            <input type="number" id="f_weight" step="0.1" placeholder="é«”é‡ (kg)">
            
            <div style="margin-top:15px; border:1px dashed #444; padding:10px; border-radius:8px;">
                <label style="color:#aaa; font-size:0.9rem;">ğŸ“¸ åœ–ç‰‡ (ä¸Šå‚³æˆ–é€£çµ)</label>
                <input type="file" id="f_img_file" accept="image/*" style="margin-top:5px;">
                <input type="text" id="f_img_url" placeholder="æˆ–è²¼ä¸Šåœ–ç‰‡é€£çµ..." style="margin-top:5px;">
            </div>
            
            <textarea id="f_note" placeholder="ä»Šæ—¥å¾©å¥å¿ƒå¾—..." rows="3"></textarea>
            <button type="submit" id="subBtn">ç¢ºèªç´€éŒ„</button>
            <button type="button" id="canBtn" style="display:none; background:#333; color:#fff;" onclick="cancelEdit()">å–æ¶ˆç·¨è¼¯</button>
        </form>
    </div>

    <div class="pixel-box">
        <canvas id="chartCanvas" height="200"></canvas>
    </div>

    <div class="pixel-box">
        <h2 style="margin-top:0;">â¤ æ­·å²ç´€éŒ„</h2>
        <div id="logContainer"></div>
    </div>

    <script>
        var DATA_KEY = "TBA360_MOBILE_V11";
        var chart = null;

        function doCountdown() {
            var target = new Date(2026, 10, 13).getTime();
            var now = new Date().getTime();
            var diff = target - now;
            var days = Math.floor(diff / (1000 * 60 * 60 * 24));
            document.getElementById('timerDisp').innerHTML = (days > 0 ? days : 0) + "<span style='font-size:1rem; color:#fff'> DAYS</span>";
        }

        window.onload = function() {
            doCountdown();
            var today = new Date();
            document.getElementById('f_date').value = today.toISOString().substr(0, 10);
            render();
            document.getElementById('mainForm').onsubmit = function(e) { e.preventDefault(); handleSave(); };
        };

        function handleSave() {
            var file = document.getElementById('f_img_file').files[0];
            var url = document.getElementById('f_img_url').value;

            if (file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var img = new Image();
                    img.onload = function() {
                        var canvas = document.createElement('canvas');
                        var ctx = canvas.getContext('2d');
                        var maxDim = 500; // æ‰‹æ©Ÿç‰ˆç¨å¾®å¤§ä¸€é»
                        var w = img.width; var h = img.height;
                        if (w > h) { if (w > maxDim) { h *= maxDim/w; w = maxDim; } }
                        else { if (h > maxDim) { w *= maxDim/h; h = maxDim; } }
                        canvas.width = w; canvas.height = h;
                        ctx.drawImage(img, 0, 0, w, h);
                        finalizeSave(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                finalizeSave(url || "");
            }
        }

        function finalizeSave(imgData) {
            try {
                var raw = localStorage.getItem(DATA_KEY);
                var items = raw ? JSON.parse(raw) : [];
                var idx = parseInt(document.getElementById('editIdx').value);
                var entry = {
                    date: document.getElementById('f_date').value,
                    knee: document.getElementById('f_knee').value,
                    sleep: document.getElementById('f_sleep').value,
                    weight: document.getElementById('f_weight').value,
                    note: document.getElementById('f_note').value,
                    img: imgData || (idx > -1 ? items[idx].img : "")
                };

                if (idx > -1 && !imgData && items[idx].img) entry.img = items[idx].img;
                if (idx > -1) items[idx] = entry; else items.unshift(entry);

                localStorage.setItem(DATA_KEY, JSON.stringify(items));
                cancelEdit(); render(); alert("ç´€éŒ„æˆåŠŸï¼");
            } catch (e) { alert("å„²å­˜å¤±æ•—ï¼šç©ºé–“ä¸è¶³"); }
        }

        function render() {
            var raw = localStorage.getItem(DATA_KEY);
            var items = raw ? JSON.parse(raw) : [];
            var lv = Math.floor(items.length / 5) + 1;
            document.getElementById('lvDisplay').innerHTML = "Lv." + lv + " é¨å£«";
            document.getElementById('xpBar').style.width = (items.length % 5) * 20 + "%";

            var container = document.getElementById('logContainer');
            container.innerHTML = items.length ? "" : "<p style='text-align:center; color:#555;'>é–‹å§‹ä½ çš„ç¬¬ä¸€æ¬¡ç´€éŒ„å§ï¼</p>";
            
            items.forEach(function(it, i) {
                var div = document.createElement('div');
                div.className = "log-item";
                div.innerHTML = "<div style='display:flex; justify-content:space-between; margin-bottom:5px;'><b>ğŸ“… " + it.date + "</b><span>" + it.knee + "</span></div>" +
                    (it.img ? '<img src="'+it.img+'" class="log-img" onerror="this.style.display=\'none\'">' : '') +
                    "<p style='color:#ddd;'>" + (it.note || "") + "</p>" +
                    "<div style='font-size:0.8rem; color:#888; margin-top:5px;'>ğŸ’¤ " + it.sleep + " | âš–ï¸ " + it.weight + "kg</div>" +
                    "<div style='margin-top:10px; display:flex; gap:10px;'><button class='s-btn' onclick='editIt("+i+")'>ç·¨è¼¯</button><button class='s-btn' style='background:#422; border-color:#622' onclick='delIt("+i+")'>åˆªé™¤</button></div>";
                container.appendChild(div);
            });
            drawChart(items);
        }

        function editIt(i) {
            var items = JSON.parse(localStorage.getItem(DATA_KEY));
            var it = items[i];
            document.getElementById('editIdx').value = i;
            document.getElementById('f_date').value = it.date;
            document.getElementById('f_knee').value = it.knee;
            document.getElementById('f_sleep').value = it.sleep;
            document.getElementById('f_weight').value = it.weight;
            if (it.img && it.img.startsWith('http')) document.getElementById('f_img_url').value = it.img;
            document.getElementById('f_note').value = it.note;
            document.getElementById('formTitle').innerText = "â¤ ç·¨è¼¯æ¨¡å¼";
            document.getElementById('subBtn').innerText = "æ›´æ–°ç´€éŒ„";
            document.getElementById('canBtn').style.display = "block";
            window.scrollTo({ top: document.getElementById('formBox').offsetTop - 20, behavior: 'smooth' });
        }

        function cancelEdit() {
            document.getElementById('editIdx').value = "-1";
            document.getElementById('mainForm').reset();
            document.getElementById('f_date').value = new Date().toISOString().substr(0, 10);
            document.getElementById('formTitle').innerText = "â¤ å¯«å…¥ç´€éŒ„";
            document.getElementById('subBtn').innerText = "ç¢ºèªç´€éŒ„";
            document.getElementById('canBtn').style.display = "none";
        }

        function delIt(i) {
            if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
                var items = JSON.parse(localStorage.getItem(DATA_KEY));
                items.splice(i, 1);
                localStorage.setItem(DATA_KEY, JSON.stringify(items));
                render();
            }
        }

        function exportData() {
            var data = localStorage.getItem(DATA_KEY);
            if(!data) return alert("ç„¡è³‡æ–™");
            var a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([data], {type: "application/json"}));
            a.download = "TBA360_Mobile_Backup.json";
            a.click();
        }

        function importData(e) {
            var reader = new FileReader();
            reader.onload = function(evt) {
                if(confirm("è¦†è“‹ç›®å‰ç´€éŒ„ï¼Ÿ")) {
                    localStorage.setItem(DATA_KEY, evt.target.result);
                    render();
                }
            };
            reader.readAsText(e.target.files[0]);
        }

        function drawChart(items) {
            if (typeof Chart === "undefined") return;
            var ctx = document.getElementById('chartCanvas').getContext('2d');
            if (chart) chart.destroy();
            var d = items.slice().reverse().slice(-7);
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: d.map(function(x){ return x.date.substr(5); }),
                    datasets: [
                        { label: 'ç¡çœ ', data: d.map(function(x){ return x.sleep; }), borderColor: '#39ff14', borderWidth: 2, tension:0.3 },
                        { label: 'é«”é‡', data: d.map(function(x){ return x.weight; }), borderColor: '#00f2ff', borderWidth: 2, tension:0.3 }
                    ]
                },
                options: {
                    responsive: true,
                    scales: { y: { grid: { color: '#333' } }, x: { grid: { display: false } } },
                    plugins: { legend: { labels: { color: '#fff' } } }
                }
            });
        }
    </script>
</body>
</html>