<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>TBA360 é›²ç«¯æˆ°æƒ…å®¤</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* (ç¶­æŒåŸæœ¬ v11 çš„ CSS æ¨£å¼ï¼Œé€™è£¡çœç•¥ä»¥ç¯€çœç¯‡å¹…ï¼Œè«‹ä¿ç•™ä½ åŸæœ¬ v11 çš„ style å€å¡Š) */
        body { background: #000; color: #fff; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; padding-top: 50px; min-height: 100vh; margin: 0; }
        .pixel-box { border: 2px solid #fff; padding: 20px; margin-bottom: 20px; width: 100%; max-width: 500px; background: #111; border-radius: 12px; box-sizing: border-box; }
        .timer-val { font-size: 3rem; color: #39ff14; text-align: center; margin: 10px 0; font-weight: bold; }
        .xp-bg { width: 100%; height: 12px; background: #333; border-radius: 6px; margin-bottom: 10px; overflow: hidden; }
        #xpBar { height: 100%; background: #00f2ff; width: 0%; transition: 0.5s; }
        input, select, textarea { width: 100%; background: #222; border: 1px solid #555; color: #fff; padding: 12px; margin-top: 10px; border-radius: 8px; box-sizing: border-box;}
        button { width: 100%; margin-top: 15px; padding: 15px; background: #fff; color: #000; border: none; font-weight: bold; font-size: 1.1rem; border-radius: 8px; }
        .log-item { border: 1px solid #333; padding: 15px; margin-top: 10px; background: #1a1a1a; border-radius: 8px; }
        .log-img { width: 100%; max-height: 300px; object-fit: cover; border-radius: 6px; margin: 10px 0; }
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); color:#39ff14; display:flex; justify-content:center; align-items:center; font-size:1.5rem; z-index:999; display:none; }
    </style>
</head>
<body>

    <div id="loading">é€£ç·šåŒæ­¥ä¸­...</div>

    <div class="pixel-box">
        <div style="display:flex; justify-content:space-between;">
            <span id="lvDisplay" style="color:#00f2ff; font-weight:bold;">Lv.1 é¨å£«</span>
            <span>2026/11/13 ç›®æ¨™</span>
        </div>
        <div class="xp-bg"><div id="xpBar"></div></div>
        <div class="timer-val" id="timerDisp">---</div>
        <div style="text-align:center; font-size:0.8rem; color:#aaa;">ğŸŸ¢ é›²ç«¯åŒæ­¥å·²å•Ÿå‹•</div>
    </div>

    <div class="pixel-box" id="formBox">
        <h2 id="formTitle" style="margin-top:0;">â¤ å¯«å…¥ç´€éŒ„</h2>
        <form id="mainForm">
            <input type="hidden" id="rowIndex" value="">
            <input type="date" id="f_date" required>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <select id="f_knee">
                    <option value="ğŸŸ¢èˆ’æœ">ğŸŸ¢ èˆ’æœ</option>
                    <option value="ğŸŸ¡å¾®é…¸">ğŸŸ¡ å¾®é…¸</option>
                    <option value="ğŸ”´ç–¼ç—›">ğŸ”´ ç–¼ç—›</option>
                </select>
                <input type="number" id="f_sleep" placeholder="ç¡çœ  (0-100)">
            </div>
            <input type="number" id="f_weight" step="0.1" placeholder="é«”é‡ (kg)">
            
            <div style="margin-top:15px; border:1px dashed #444; padding:10px; border-radius:8px;">
                <label style="color:#aaa; font-size:0.9rem;">ğŸ“¸ åœ–ç‰‡ (è‡ªå‹•å£“ç¸®)</label>
                <input type="file" id="f_img_file" accept="image/*" style="margin-top:5px;">
            </div>
            
            <textarea id="f_note" placeholder="å¿ƒå¾—..." rows="3"></textarea>
            <button type="submit" id="subBtn">å‚³é€åˆ°é›²ç«¯</button>
            <button type="button" id="canBtn" style="display:none; background:#333; color:#fff;" onclick="cancelEdit()">å–æ¶ˆ</button>
        </form>
    </div>

    <div class="pixel-box">
        <canvas id="chartCanvas" height="200"></canvas>
    </div>

    <div class="pixel-box">
        <h2 style="margin-top:0;">â¤ æ­·å²ç´€éŒ„</h2>
        <div id="logContainer"></div>
    </div>

    <script>
        // â˜…â˜…â˜… è«‹æŠŠé€™è£¡æ›æˆä½ çš„ Apps Script ç¶²å€ â˜…â˜…â˜…
        var GAS_URL = "https://script.google.com/macros/s/AKfycbxjbykUNcsRwXiHqNVQ8JjjgDQ2YpDG4CFgiMxrb6mdypln84A3rtHvXy7BoJAwxn9S/exec";
        
        var chart = null;
        var globalData = [];

        function doCountdown() {
            var target = new Date(2026, 10, 13).getTime();
            var diff = target - new Date().getTime();
            var days = Math.floor(diff / (1000 * 60 * 60 * 24));
            document.getElementById('timerDisp').innerHTML = (days > 0 ? days : 0) + "<span style='font-size:1rem; color:#fff'> DAYS</span>";
        }

        window.onload = function() {
            doCountdown();
            document.getElementById('f_date').value = new Date().toISOString().substr(0, 10);
            fetchData(); // å•Ÿå‹•æ™‚å¾é›²ç«¯è®€å–
            document.getElementById('mainForm').onsubmit = function(e) { e.preventDefault(); handleSave(); };
        };

        // å¾ Google Sheet è®€å–è³‡æ–™
        function fetchData() {
            document.getElementById('loading').style.display = 'flex';
            fetch(GAS_URL + "?action=read")
            .then(res => res.json())
            .then(data => {
                // Sheet çš„è³‡æ–™æ˜¯æ­£åº (èˆŠ->æ–°)ï¼Œæˆ‘å€‘åè½‰å®ƒè®“æœ€æ–°çš„åœ¨æœ€ä¸Šé¢
                globalData = data.reverse(); 
                render(globalData);
                document.getElementById('loading').style.display = 'none';
            })
            .catch(err => {
                console.error(err);
                alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
                document.getElementById('loading').style.display = 'none';
            });
        }

        function handleSave() {
            document.getElementById('loading').style.display = 'flex';
            var file = document.getElementById('f_img_file').files[0];

            if (file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var img = new Image();
                    img.onload = function() {
                        var canvas = document.createElement('canvas');
                        var ctx = canvas.getContext('2d');
                        var maxDim = 400; // é›²ç«¯ç‰ˆé™åˆ¶ 400px ä»¥å…è¶…éå–®æ ¼é™åˆ¶
                        var w = img.width; var h = img.height;
                        if (w > h) { if (w > maxDim) { h *= maxDim/w; w = maxDim; } }
                        else { if (h > maxDim) { w *= maxDim/h; h = maxDim; } }
                        canvas.width = w; canvas.height = h;
                        ctx.drawImage(img, 0, 0, w, h);
                        sendToSheet(canvas.toDataURL('image/jpeg', 0.6));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                // å¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ä¸”æ²’å‚³æ–°åœ–ï¼Œè¦æ‰¾å›èˆŠåœ–
                var currentImg = "";
                var idx = document.getElementById('rowIndex').value; 
                // æ³¨æ„ï¼šé€™è£¡ç°¡åŒ–è™•ç†ï¼Œç·¨è¼¯æ™‚è‹¥æ²’é¸åœ–ï¼Œæš«æ™‚ä¸ä¿ç•™èˆŠåœ–(å› ç‚º Apps Script é‚è¼¯è¼ƒè¤‡é›œ)ï¼Œå»ºè­°ç·¨è¼¯æ™‚è‹¥è¦ç•™åœ–éœ€é‡æ–°ä¸Šå‚³ï¼Œæˆ–åªæ”¹æ–‡å­—ã€‚
                // ç‚ºäº†ç”¨æˆ¶é«”é©—ï¼Œæˆ‘å€‘å‡è¨­ç·¨è¼¯æ˜¯ã€Œè¦†è“‹ã€
                sendToSheet("");
            }
        }

        function sendToSheet(imgData) {
            var formData = new FormData();
            formData.append('date', document.getElementById('f_date').value);
            formData.append('knee', document.getElementById('f_knee').value);
            formData.append('sleep', document.getElementById('f_sleep').value);
            formData.append('weight', document.getElementById('f_weight').value);
            formData.append('note', document.getElementById('f_note').value);
            formData.append('img', imgData);
            
            // å¦‚æœæœ‰ rowIndex ä»£è¡¨æ˜¯ç·¨è¼¯
            var rowIndex = document.getElementById('rowIndex').value;
            if (rowIndex) formData.append('rowIndex', rowIndex);

            fetch(GAS_URL, {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.result === "success") {
                    alert("é›²ç«¯åŒæ­¥æˆåŠŸï¼");
                    cancelEdit();
                    fetchData(); // é‡æ–°è®€å–
                } else {
                    alert("å¯«å…¥å¤±æ•—");
                    document.getElementById('loading').style.display = 'none';
                }
            })
            .catch(err => {
                alert("éŒ¯èª¤ï¼š" + err);
                document.getElementById('loading').style.display = 'none';
            });
        }

        function render(items) {
            var lv = Math.floor(items.length / 5) + 1;
            document.getElementById('lvDisplay').innerHTML = "Lv." + lv + " é¨å£«";
            document.getElementById('xpBar').style.width = (items.length % 5) * 20 + "%";

            var container = document.getElementById('logContainer');
            container.innerHTML = items.length ? "" : "<p style='text-align:center; color:#555;'>é›²ç«¯ç„¡è³‡æ–™</p>";
            
            // è¨ˆç®—åŸæœ¬åœ¨ Sheet ä¸­çš„ Row Index (å‡è¨­ headers ä½” 1 åˆ—)
            // å› ç‚º items æ˜¯åè½‰éçš„ (æœ€æ–°åœ¨ sheet æœ€ä¸‹é¢)ï¼Œæ‰€ä»¥ items[0] å°æ‡‰ sheet çš„ lastRow
            // ç‚ºäº†ç°¡å–®ï¼Œæˆ‘å€‘ç·¨è¼¯åŠŸèƒ½å…ˆåªåšã€Œé¡¯ç¤ºã€ï¼Œä¸åšè¤‡é›œçš„ Row è¨ˆç®—ï¼Œé¿å…å‡ºéŒ¯ã€‚
            // é€™è£¡ç°¡åŒ–ï¼šæš«æ™‚ä¸æ”¯æ´ç·¨è¼¯èˆŠè³‡æ–™ï¼Œåªæ”¯æ´æ–°å¢ã€‚
            // è‹¥è¦æ”¯æ´ç·¨è¼¯ï¼Œéœ€åœ¨è®€å–æ™‚å°‡ rowIndex ä¸€ä½µå›å‚³ã€‚
            
            items.forEach(function(it) {
                var div = document.createElement('div');
                div.className = "log-item";
                div.innerHTML = "<div style='display:flex; justify-content:space-between;'><b>ğŸ“… " + it.date + "</b><span>" + it.knee + "</span></div>" +
                    (it.img ? '<img src="'+it.img+'" class="log-img">' : '') +
                    "<p style='color:#ddd;'>" + (it.note || "") + "</p>" +
                    "<div style='font-size:0.8rem; color:#888;'>ğŸ’¤ " + it.sleep + " | âš–ï¸ " + it.weight + "kg</div>";
                container.appendChild(div);
            });
            drawChart(items);
        }
        
        function cancelEdit() {
            document.getElementById('mainForm').reset();
            document.getElementById('rowIndex').value = "";
            document.getElementById('f_date').value = new Date().toISOString().substr(0, 10);
            document.getElementById('subBtn').innerText = "å‚³é€åˆ°é›²ç«¯";
            document.getElementById('canBtn').style.display = "none";
        }

        function drawChart(items) {
            if (typeof Chart === "undefined") return;
            var ctx = document.getElementById('chartCanvas').getContext('2d');
            if (chart) chart.destroy();
            // åœ–è¡¨éœ€è¦æ™‚é–“ç”±èˆŠåˆ°æ–°
            var d = items.slice().reverse().slice(-7);
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: d.map(function(x){ return x.date.substr(5); }),
                    datasets: [
                        { label: 'ç¡çœ ', data: d.map(function(x){ return x.sleep; }), borderColor: '#39ff14', borderWidth: 2 },
                        { label: 'é«”é‡', data: d.map(function(x){ return x.weight; }), borderColor: '#00f2ff', borderWidth: 2 }
                    ]
                },
                options: {
                    responsive: true,
                    scales: { y: { grid: { color: '#333' } }, x: { grid: { display: false } } },
                    plugins: { legend: { labels: { color: '#fff' } } }
                }
            });
        }
    </script>
</body>
</html>

