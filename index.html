<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>TBA360 v32 Smart HD</title>
<style>
/* åŸºç¤æ¨£å¼ */
body { background: #000; color: #fff; font-family: -apple-system, system-ui, sans-serif; margin: 0; padding-bottom: 50px; display: flex; flex-direction: column; align-items: center; }

/* Banner */
.banner { 
    width: 100%; height: 300px; 
    background-color: #000; 
    background-image: url('https://i.meee.com.tw/0neg3F9.png'); 
    background-size: contain; background-repeat: no-repeat; background-position: center; 
    border-bottom: 4px solid #00f2ff; margin-bottom: 20px; position: relative;
}
.banner-text {
    position: absolute; bottom: 10px; right: 10px;
    font-size: 1.5rem; font-weight: bold; font-style: italic; color: #fff; text-shadow: 0 0 10px #00f2ff;
    background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 5px; border: 1px solid #00f2ff;
}
/* æ–°å¢ï¼šç‰ˆæœ¬è™Ÿæ¨™ç±¤ */
.version-tag {
    position: absolute; top: 10px; right: 10px;
    font-size: 0.75rem; color: rgba(255,255,255,0.4); font-family: monospace; letter-spacing: 1px;
}

/* å®¹å™¨ */
.box { border: 1px solid #333; padding: 20px; margin-bottom: 20px; width: 90%; max-width: 500px; background: #111; border-radius: 12px; box-sizing: border-box; }

/* æˆ°é¬¥åŠ›èˆ‡é¢æ¿ */
.cp-val { font-size: 3.5rem; color: #ff3131; font-weight: 900; text-align: center; font-family: monospace; text-shadow: 0 0 15px #f00; margin: 5px 0; }
.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; text-align: center; }
.card { background: #1a1a1a; padding: 10px; border-radius: 8px; border: 1px solid #333; }
.val { font-size: 1.2rem; color: #39ff14; font-weight: bold; }
.lbl { font-size: 0.8rem; color: #888; margin-top: 2px; }
.status-row { margin-top: 20px; padding-top: 15px; border-top: 1px dashed #333; display: flex; justify-content: space-around; }
.status-val { font-size: 1.5rem; font-weight: bold; color: #fff; }
.status-lbl { font-size: 0.8rem; color: #aaa; margin-top: 2px; }
.lv-row { display: flex; justify-content: space-between; margin-top: 15px; color: #00f2ff; font-weight: bold; }
.days { color: #39ff14; }
.xp-bg { width: 100%; height: 8px; background: #333; margin-top: 5px; border-radius: 4px; overflow: hidden; }
.xp-fill { height: 100%; background: #00f2ff; width: 0%; transition: width 0.5s; }

/* è¡¨å–® */
input, select, textarea { width: 100%; background: #222; border: 1px solid #555; color: #fff; padding: 12px; margin-top: 10px; border-radius: 6px; box-sizing: border-box; font-size: 16px; -webkit-appearance: none; }
button { width: 100%; margin-top: 15px; padding: 15px; background: #fff; color: #000; border: none; font-weight: bold; border-radius: 8px; cursor: pointer; font-size: 1.1rem; }
button:disabled { background: #555; color: #888; }
.pass-input { border: 1px solid #ff3131; background: #220000; color: #ffaaaa; letter-spacing: 5px; text-align: center; font-weight: bold; }

/* åˆ—è¡¨ */
.item { border: 1px solid #333; padding: 15px; margin-top: 10px; background: #1a1a1a; border-radius: 8px; }
.item-head { display: flex; justify-content: space-between; margin-bottom: 5px; }
.tag { background: #004444; color: #00f2ff; padding: 2px 6px; font-size: 0.8rem; border-radius: 4px; }
.item img { width: 100%; margin-top: 10px; border-radius: 5px; border: 1px solid #333; }

/* ç•™è¨€æ¿ */
.msg-item { border-bottom: 1px solid #333; padding: 10px 0; }
.msg-head { display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; }
.msg-body { margin-top: 5px; font-size: 1rem; color: #ddd; }
.msg-name { color: #39ff14; font-weight: bold; }

#loading { text-align: center; color: #00f2ff; margin: 10px 0; display: none; }
</style>
</head>
<body>

<div class="banner">
    <div class="version-tag">v32.0 (Smart HD)</div>
    <div class="banner-text">TBA360 æˆ°æƒ…å®¤</div>
</div>

<div class="box">
    <div style="text-align:center;color:#888;letter-spacing:2px">æˆ°é¬¥åŠ› (CP)</div>
    <div class="cp-val" id="cpVal">0</div>
    
    <div class="grid">
        <div class="card"><div class="val" id="tDist">0</div><div class="lbl">é‡Œç¨‹ (km)</div></div>
        <div class="card"><div class="val" id="tTime">0</div><div class="lbl">æ™‚æ•¸ (min)</div></div>
        <div class="card"><div class="val" id="tCal">0</div><div class="lbl">å¡è·¯é‡Œ</div></div>
        <div class="card"><div class="val" id="tCount">0</div><div class="lbl">æ¬¡æ•¸</div></div>
    </div>

    <div class="status-row">
        <div style="text-align:center">
            <div class="status-val" id="avgSleep">--</div>
            <div class="status-lbl">è¿‘3æ—¥å‡çœ </div>
        </div>
        <div style="text-align:center">
            <div class="status-val" id="avgWeight">--</div>
            <div class="status-lbl">è¿‘3æ—¥å‡é‡</div>
        </div>
    </div>

    <div class="lv-row">
        <span id="lvDisp">Lv.1 é¨å£«</span>
        <span class="days" id="daysDisp">---</span>
    </div>
    <div class="xp-bg"><div class="xp-fill" id="xpBar"></div></div>
</div>

<div class="box">
    <h3 style="margin-top:0;border-bottom:1px solid #333;padding-bottom:10px">ğŸ”’ å¯«å…¥ç´€éŒ„ (Admin)</h3>
    <input type="date" id="i_date">
    <div class="grid" style="margin-top:0">
        <select id="i_type">
            <option>ğŸš´ é¨è¡Œ</option><option>ğŸš¶ å¿«èµ°</option><option>ğŸƒ è·‘æ­¥</option>
            <option>ğŸ€ æ‰“çƒ</option><option>ğŸ‹ï¸ é‡è¨“</option><option>ğŸ›Œ ä¼‘æ¯</option>
        </select>
        <select id="i_knee"><option>ğŸŸ¢èˆ’æœ</option><option>ğŸŸ¡å¾®é…¸</option><option>ğŸ”´ç–¼ç—›</option></select>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px">
        <input type="number" id="i_dist" placeholder="km" step="0.1">
        <input type="number" id="i_time" placeholder="min" step="1">
        <input type="number" id="i_cal" placeholder="cal">
    </div>
    <div class="grid">
        <input type="number" id="i_sleep" placeholder="ç¡çœ ">
        <input type="number" id="i_weight" placeholder="é«”é‡" step="0.1">
    </div>
    <div style="margin-top:10px;border:1px dashed #444;padding:10px">
        <label style="color:#aaa;font-size:0.9rem">ğŸ“¸ åœ–ç‰‡</label>
        <input type="file" id="i_file" accept="image/*" style="margin-top:5px">
    </div>
    <textarea id="i_note" placeholder="å¿ƒå¾—..."></textarea>
    <input type="password" id="i_pass" class="pass-input" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
    <button id="btnSave">é€å‡ºç´€éŒ„</button>
</div>

<div class="box">
    <h3 style="margin-top:0">â¤ æ­·å²ç´€éŒ„</h3>
    <div id="loading">â˜ï¸ åŒæ­¥ä¸­...</div>
    <div id="list"></div>
</div>

<div class="box">
    <h3 style="margin-top:0;border-bottom:1px solid #333;padding-bottom:10px">ğŸ’¬ æˆ°å‹ç•™è¨€æ¿</h3>
    <div id="msgList" style="max-height:300px;overflow-y:auto;margin-bottom:10px">
        <div style="color:#555;text-align:center">æš«ç„¡ç•™è¨€</div>
    </div>
    <div style="border-top:1px dashed #444;padding-top:10px">
        <input type="text" id="m_name" placeholder="æ‚¨çš„æš±ç¨±">
        <input type="text" id="m_text" placeholder="å¯«å¥åŠ æ²¹çš„è©±...">
        <button id="btnMsg" style="background:#004444;color:#00f2ff;border:1px solid #00f2ff">ğŸ“¢ ç™¼é€ç•™è¨€ (+1% CP)</button>
    </div>
</div>

<script>
// â–¼ è¨­å®šå€ â–¼
var GAS_URL = "https://script.google.com/macros/s/AKfycbxjbykUNcsRwXiHqNVQ8JjjgDQ2YpDG4CFgiMxrb6mdypln84A3rtHvXy7BoJAwxn9S/exec";
var KEY = "TBA360_V32";
var ADMIN_PASS = "8888"; 
// â–² è¨­å®šå€ â–²

var globalMsgCount = 0;
var saveTimeout = null; 

window.onload = function() {
    document.getElementById('i_date').value = new Date().toISOString().slice(0,10);
    
    var diff = new Date(2026,10,13) - new Date();
    var d = Math.floor(diff/86400000);
    document.getElementById('daysDisp').innerText = (d>0?d:0) + " DAYS LEFT";

    loadLocal();
    if(GAS_URL) loadCloud();

    document.getElementById('btnSave').onclick = saveData;
    document.getElementById('btnMsg').onclick = sendMsg;
};

function loadLocal() {
    try {
        var d = JSON.parse(localStorage.getItem(KEY) || "[]");
        render(d);
    } catch(e) { console.error("Local load error", e); }
}

function loadCloud() {
    document.getElementById('loading').style.display = 'block';
    fetch(GAS_URL)
    .then(r => r.json())
    .then(d => {
        document.getElementById('loading').style.display = 'none';
        if(d.msgs) {
            globalMsgCount = d.msgs.length;
            renderMsgs(d.msgs);
        }
        if(d.logs) {
            try {
                localStorage.setItem(KEY, JSON.stringify(d.logs.slice(0, 10)));
            } catch(e) { console.warn("LocalStorage ä»æ»¿", e); }
            render(d.logs);
        }
    })
    .catch(e => {
        document.getElementById('loading').style.display = 'none';
        console.log("Cloud Err:", e);
    });
}

function saveData() {
    var pass = document.getElementById('i_pass').value;
    if(pass !== ADMIN_PASS) { alert("âŒ å¯†ç¢¼éŒ¯èª¤"); return; }

    var btn = document.getElementById('btnSave');
    btn.innerText = "æº–å‚™ä¸­...";
    btn.disabled = true;

    saveTimeout = setTimeout(function() {
        alert("âš ï¸ è™•ç†é€¾æ™‚ï¼å¯èƒ½æ˜¯åœ–ç‰‡å¤ªå¤§ã€‚");
        resetUI();
    }, 20000);

    var file = document.getElementById('i_file').files[0];
    if(file) {
        var imgUrl = URL.createObjectURL(file);
        btn.innerText = "æœ€ä½³åŒ–å£“ç¸®ä¸­...";
        
        resizeImg(imgUrl, function(base64) {
            URL.revokeObjectURL(imgUrl);
            commitSave(base64);
        });
    } else {
        commitSave("");
    }
}

function resizeImg(src, cb) {
    var img = new Image();
    img.onerror = function() {
        alert("åœ–ç‰‡è¼‰å…¥éŒ¯èª¤");
        cb(""); 
    };
    img.onload = function() {
        var c = document.createElement('canvas');
        // â˜… è§£æåº¦æå‡è‡³ 600pxï¼Œç•«è³ªå¤§å¹…æ”¹å–„
        var max = 600; 
        var w = img.width, h = img.height;
        if(w>h){ if(w>max){h*=max/w; w=max}} else{ if(h>max){w*=max/h; h=max}}
        c.width=w; c.height=h;
        var ctx = c.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);
        
        // â˜… æ™ºæ…§å‹•æ…‹å£“ç¸®ï¼šæ¸¬è©¦æœ€ä½³ç•«è³ªï¼Œç¢ºä¿ä¸è¶…é Google Sheet çš„ 5è¬å­—å…ƒé™åˆ¶ (å®‰å…¨æŠ“ 45000)
        var quality = 0.8; // å¾ 80% é«˜ç•«è³ªé–‹å§‹è©¦
        var base64 = c.toDataURL('image/jpeg', quality);
        
        // å¦‚æœå¤ªå¤§ï¼Œå°±é€æ¼¸é™ä½ç•«è³ªï¼Œç›´åˆ°å¡å¾—ä¸‹ç‚ºæ­¢
        while (base64.length > 45000 && quality > 0.1) {
            quality -= 0.1;
            base64 = c.toDataURL('image/jpeg', parseFloat(quality.toFixed(1)));
        }
        
        console.log("å£“ç¸®å®Œç•¢, å“è³ª:", quality.toFixed(1), "å¤§å°:", base64.length);
        cb(base64);
    };
    img.src = src;
}

function commitSave(img64) {
    var btn = document.getElementById('btnSave');
    btn.innerText = "ä¸Šå‚³é›²ç«¯ä¸­...";

    var obj = {
        date: document.getElementById('i_date').value,
        type: document.getElementById('i_type').value,
        knee: document.getElementById('i_knee').value,
        dist: document.getElementById('i_dist').value,
        time: document.getElementById('i_time').value,
        cal: document.getElementById('i_cal').value,
        sleep: document.getElementById('i_sleep').value,
        weight: document.getElementById('i_weight').value,
        note: document.getElementById('i_note').value,
        img: img64
    };

    try {
        var list = JSON.parse(localStorage.getItem(KEY) || "[]");
        list.unshift(obj);
        if(list.length > 10) list = list.slice(0, 10);
        localStorage.setItem(KEY, JSON.stringify(list));
        render(list);
    } catch(e) { console.warn("ç„¡æ³•å­˜å…¥æœ¬æ©Ÿ", e); }

    if(GAS_URL) {
        fetch(GAS_URL, {
            method: 'POST',
            headers: {'Content-Type': 'text/plain;charset=utf-8'},
            body: JSON.stringify(obj)
        })
        .then(r => r.json())
        .then(d => {
            clearTimeout(saveTimeout);
            alert("âœ… ç´€éŒ„æˆåŠŸ");
            resetUI();
            loadCloud();
        })
        .catch(e => {
            clearTimeout(saveTimeout);
            alert("âš ï¸ å­˜å…¥æœ¬æ©Ÿ (é›²ç«¯å¤±æ•—)");
            resetUI();
        });
    } else {
        clearTimeout(saveTimeout);
        alert("âœ… æœ¬æ©Ÿå·²å­˜");
        resetUI();
    }
}

function sendMsg() {
    var name = document.getElementById('m_name').value;
    var text = document.getElementById('m_text').value;
    if(!name || !text) { alert("è«‹è¼¸å…¥æš±ç¨±å’Œå…§å®¹"); return; }

    var btn = document.getElementById('btnMsg');
    btn.innerText = "ç™¼é€ä¸­...";
    btn.disabled = true;

    var msgData = {
        action: "msg", 
        time: new Date().toISOString().slice(0,10),
        name: name,
        text: text
    };

    if(GAS_URL) {
        fetch(GAS_URL, {
            method: 'POST',
            headers: {'Content-Type': 'text/plain;charset=utf-8'},
            body: JSON.stringify(msgData)
        })
        .then(r => r.json())
        .then(d => {
            alert("âœ… ç•™è¨€æˆåŠŸï¼æˆ°é¬¥åŠ› UPï¼");
            document.getElementById('m_text').value = "";
            btn.innerText = "ğŸ“¢ ç™¼é€ç•™è¨€ (+1% CP)";
            btn.disabled = false;
            loadCloud(); 
        })
        .catch(e => {
            alert("ç™¼é€å¤±æ•—");
            btn.disabled = false;
        });
    }
}

function resetUI() {
    clearTimeout(saveTimeout);
    document.getElementById('btnSave').innerText = "é€å‡ºç´€éŒ„";
    document.getElementById('btnSave').disabled = false;
    document.getElementById('i_note').value = "";
    document.getElementById('i_file').value = "";
    document.getElementById('i_pass').value = "";
}

function renderMsgs(msgs) {
    var el = document.getElementById('msgList');
    if(!msgs || msgs.length === 0) {
        el.innerHTML = '<div style="color:#555;text-align:center">æš«ç„¡ç•™è¨€</div>';
        return;
    }
    el.innerHTML = "";
    msgs.forEach(m => {
        var div = document.createElement('div');
        div.className = "msg-item";
        div.innerHTML = `
            <div class="msg-head"><span class="msg-name">${m.name}</span> <span>${m.time}</span></div>
            <div class="msg-body">${m.text}</div>
        `;
        el.appendChild(div);
    });
}

function render(list) {
    var cDist=0, cTime=0, cCal=0, cCount=0;
    var lastW=80, lastS=60;

    var elList = document.getElementById('list');
    elList.innerHTML = "";

    if(list.length > 0) {
        lastW = parseFloat(list[0].weight) || 80;
        lastS = parseFloat(list[0].sleep) || 60;
    }

    list.forEach(item => {
        if(item.type !== "ğŸ›Œ ä¼‘æ¯") {
            cCount++;
            cDist += parseFloat(item.dist||0);
            cTime += parseFloat(item.time||0);
            cCal += parseFloat(item.cal||0);
        }
        
        var div = document.createElement('div');
        div.className = "item";
        div.innerHTML = `
            <div class="item-head">
                <b style="color:#00f2ff">${item.date}</b>
                <span class="tag">${item.type}</span>
            </div>
            <div style="margin:5px 0;color:#aaa;font-size:0.9rem">${item.knee} | ğŸ’¤${item.sleep} | âš–ï¸${item.weight}kg</div>
            <div style="color:#39ff14;font-size:0.9rem;font-weight:bold">
                ${item.dist?item.dist+'km ':''} ${item.time?item.time+'min ':''} ${item.cal?'ğŸ”¥'+item.cal:''}
            </div>
            <div style="color:#fff;margin-top:5px;font-size:0.95rem">${item.note||''}</div>
            ${item.img ? '<img src="'+item.img+'">' : ''}
        `;
        elList.appendChild(div);
    });

    document.getElementById('tDist').innerText = cDist.toFixed(1);
    document.getElementById('tTime').innerText = cTime; 
    document.getElementById('tCal').innerText = cCal;
    document.getElementById('tCount').innerText = cCount;
    
    var lv = Math.floor(cCount/5)+1;
    document.getElementById('lvDisp').innerText = "Lv." + lv + " é¨å£«";
    document.getElementById('xpBar').style.width = (cCount%5)*20 + "%";

    var base = cDist + cTime + cCal; 
    var multi = 1 + (cCount + (80-lastW)*10 + (lastS/60) + cCount + globalMsgCount)/100;
    document.getElementById('cpVal').innerText = Math.floor(base * multi).toLocaleString();

    var sleepList = list.filter(function(x){ return x.sleep && parseFloat(x.sleep)>0; });
    var weightList = list.filter(function(x){ return x.weight && parseFloat(x.weight)>0; });

    if(sleepList.length > 0) {
        var sCount = Math.min(sleepList.length, 3);
        var sSum = 0;
        for(var i=0; i<sCount; i++) sSum += parseFloat(sleepList[i].sleep);
        var sAvg = (sSum / sCount).toFixed(1);
        var sColor = sAvg >= 70 ? "#39ff14" : (sAvg >= 60 ? "#ffff00" : "#ff3131");
        document.getElementById('avgSleep').innerHTML = `<span style="color:${sColor}">${sAvg}</span>`;
    } else { document.getElementById('avgSleep').innerText = "--"; }

    if(weightList.length > 0) {
        var wCount = Math.min(weightList.length, 3);
        var wSum = 0;
        for(var j=0; j<wCount; j++) wSum += parseFloat(weightList[j].weight);
        var wAvg = (wSum / wCount).toFixed(1);
        var currentW = parseFloat(weightList[0].weight);
        var wColor = currentW < wAvg ? "#39ff14" : (currentW > wAvg ? "#ff3131" : "#fff");
        document.getElementById('avgWeight').innerHTML = `<span style="color:${wColor}">${wAvg} kg</span>`;
    } else { document.getElementById('avgWeight').innerText = "--"; }
}
</script>
</body>
</html>
