<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'self' data: blob: 'unsafe-inline' 'unsafe-eval';">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>TBA360 v16 Sync</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; padding-top: 50px; min-height: 100vh; margin: 0; }
        .pixel-box { border: 2px solid #fff; padding: 20px; margin-bottom: 20px; width: 100%; max-width: 500px; background: #111; border-radius: 12px; box-sizing: border-box; }
        .timer-val { font-size: 3rem; color: #39ff14; text-align: center; margin: 10px 0; font-weight: bold; }
        .xp-bg { width: 100%; height: 12px; background: #333; border-radius: 6px; margin-bottom: 10px; overflow: hidden; }
        #xpBar { height: 100%; background: #00f2ff; width: 0%; transition: 0.5s; }
        input, select, textarea { width: 100%; background: #222; border: 1px solid #555; color: #fff; padding: 12px; margin-top: 10px; border-radius: 8px; box-sizing: border-box; font-size: 16px; -webkit-appearance: none; }
        button { width: 100%; margin-top: 15px; padding: 15px; background: #fff; color: #000; border: none; font-weight: bold; font-size: 1.1rem; border-radius: 8px; }
        .log-item { border: 1px solid #333; padding: 15px; margin-top: 10px; background: #1a1a1a; border-radius: 8px; position: relative; }
        .log-img { width: 100%; max-height: 300px; object-fit: cover; border-radius: 6px; margin: 10px 0; }
        .status-dot { height: 10px; width: 10px; background-color: #555; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-active { background-color: #39ff14; box-shadow: 0 0 5px #39ff14; }
        .source-tag { position: absolute; top: 10px; right: 10px; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; }
        .tag-cloud { background: #004400; color: #39ff14; border: 1px solid #39ff14; }
        .tag-local { background: #444400; color: #ffff00; border: 1px solid #ffff00; }
        
        #loading-indicator { text-align: center; color: #00f2ff; font-size: 0.9rem; margin: 10px 0; display: none; }
    </style>
</head>
<body>

    <div class="pixel-box">
        <div style="display:flex; justify-content:space-between;">
            <span id="lvDisplay" style="color:#00f2ff; font-weight:bold;">Lv.1 é¨å£«</span>
            <span style="font-size: 0.8rem; color: #888;">v16.0 (Cloud Sync)</span>
        </div>
        <div class="xp-bg"><div id="xpBar"></div></div>
        <div class="timer-val" id="timerDisp">---</div>
        <div style="text-align:center; font-size:0.8rem; color:#aaa;">
            <span id="cloudStatus" class="status-dot"></span><span id="cloudText">åˆå§‹åŒ–ä¸­...</span>
        </div>
    </div>

    <div class="pixel-box">
        <h2 style="margin-top:0; border-bottom:1px solid #333; padding-bottom:10px;">â¤ å¯«å…¥ç´€éŒ„</h2>
        <form id="mainForm">
            <input type="date" id="f_date" required>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <select id="f_knee">
                    <option value="ğŸŸ¢èˆ’æœ">ğŸŸ¢ èˆ’æœ</option>
                    <option value="ğŸŸ¡å¾®é…¸">ğŸŸ¡ å¾®é…¸</option>
                    <option value="ğŸ”´ç–¼ç—›">ğŸ”´ ç–¼ç—›</option>
                </select>
                <input type="number" id="f_sleep" placeholder="ç¡çœ  (0-100)">
            </div>
            <input type="number" id="f_weight" step="0.1" placeholder="é«”é‡ (kg)">
            <div style="margin-top:10px; border:1px dashed #444; padding:10px; border-radius:8px;">
                <label for="f_img_file" style="color:#aaa; font-size:0.9rem;">ğŸ“¸ åœ–ç‰‡ (è‡ªå‹•å£“ç¸®)</label>
                <input type="file" id="f_img_file" accept="image/*" style="margin-top:5px;">
            </div>
            <textarea id="f_note" placeholder="å¿ƒå¾—..." rows="3"></textarea>
            <button type="submit" id="subBtn">ç¢ºèªç´€éŒ„</button>
        </form>
    </div>

    <div class="pixel-box">
        <canvas id="chartCanvas" height="200"></canvas>
    </div>

    <div class="pixel-box">
        <h2 style="margin-top:0;">â¤ æ­·å²ç´€éŒ„</h2>
        <div id="loading-indicator">â˜ï¸ æ­£åœ¨å¾é›²ç«¯ä¸‹è¼‰è³‡æ–™...</div>
        <div id="logContainer"></div>
    </div>

    <script>
        // ==========================================
        var GAS_URL = "https://script.google.com/macros/s/AKfycbxjbykUNcsRwXiHqNVQ8JjjgDQ2YpDG4CFgiMxrb6mdypln84A3rtHvXy7BoJAwxn9S/exec"; // â˜…â˜…â˜… è«‹å‹™å¿…å¡«å…¥ä½ çš„ Google Apps Script ç¶²å€ (çµå°¾ /exec) â˜…â˜…â˜…
        // ==========================================

        var LOCAL_KEY = "TBA360_V16_SYNC";

        window.onload = function() {
            initApp();
        };

        function initApp() {
            var today = new Date();
            document.getElementById('f_date').value = today.toISOString().substr(0, 10);
            
            // å€’æ•¸è¨ˆæ™‚
            try {
                var target = new Date(2026, 10, 13).getTime();
                var diff = target - new Date().getTime();
                var days = Math.floor(diff / (1000 * 60 * 60 * 24));
                document.getElementById('timerDisp').innerHTML = (days > 0 ? days : 0) + "<span style='font-size:1rem; color:#fff'> DAYS</span>";
            } catch(e) {}

            // 1. å…ˆé¡¯ç¤ºæœ¬æ©Ÿè³‡æ–™ (é¿å…ç•«é¢ç©ºç™½)
            renderLocal();

            // 2. å•Ÿå‹•é›²ç«¯åŒæ­¥
            if (GAS_URL && GAS_URL.startsWith("http")) {
                document.getElementById('cloudStatus').classList.add('status-active');
                document.getElementById('cloudText').innerText = "é›²ç«¯é€£ç·šä¸­...";
                fetchCloudData(); // <--- é€™æ˜¯ v16 çš„é—œéµï¼šå»è®€è³‡æ–™ï¼
            } else {
                document.getElementById('cloudText').innerText = "å–®æ©Ÿæ¨¡å¼";
            }

            document.getElementById('subBtn').onclick = function(e) {
                e.preventDefault();
                processForm();
            };
        }

        // å¾é›²ç«¯è®€å–è³‡æ–™ (GET)
        function fetchCloudData() {
            document.getElementById('loading-indicator').style.display = 'block';
            
            fetch(GAS_URL)
            .then(res => res.json())
            .then(data => {
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('cloudText').innerText = "åŒæ­¥å®Œæˆ";
                // é›²ç«¯è³‡æ–™å›ä¾†äº†ï¼æˆ‘å€‘å„ªå…ˆé¡¯ç¤ºé›²ç«¯è³‡æ–™ (å› ç‚ºé‚£æ˜¯æœ€å®Œæ•´çš„)
                if (data && data.length > 0) {
                    renderCloud(data);
                } else {
                    // å¦‚æœé›²ç«¯æ²’è³‡æ–™ï¼Œç¶­æŒé¡¯ç¤ºæœ¬æ©Ÿ
                    console.log("é›²ç«¯ç„¡è³‡æ–™");
                }
            })
            .catch(err => {
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('cloudText').innerText = "åŒæ­¥å¤±æ•— (é¡¯ç¤ºæœ¬æ©Ÿ)";
                console.error("Fetch Error:", err);
            });
        }

        // æ¸²æŸ“é›²ç«¯è³‡æ–™
        function renderCloud(items) {
            var container = document.getElementById('logContainer');
            container.innerHTML = ""; // æ¸…ç©ºæœ¬æ©Ÿè³‡æ–™ï¼Œæ”¹é¡¯ç¤ºé›²ç«¯

            updateLevel(items.length);

            items.forEach(function(it) {
                var div = document.createElement('div');
                div.className = "log-item";
                div.innerHTML = 
                    "<span class='source-tag tag-cloud'>CLOUD</span>" +
                    "<div style='display:flex; justify-content:space-between;'><b>ğŸ“… " + it.date + "</b><span>" + it.knee + "</span></div>" +
                    (it.img ? '<img src="'+it.img+'" class="log-img">' : '') +
                    "<p style='color:#ddd;'>" + (it.note || "") + "</p>" +
                    "<div style='font-size:0.8rem; color:#888;'>ğŸ’¤ " + it.sleep + " | âš–ï¸ " + it.weight + "kg</div>";
                container.appendChild(div);
            });
            drawChart(items);
        }

        // æ¸²æŸ“æœ¬æ©Ÿè³‡æ–™ (å‚™æ¡ˆ)
        function renderLocal() {
            var raw = localStorage.getItem(LOCAL_KEY);
            var items = raw ? JSON.parse(raw) : [];
            if (items.length === 0) return;

            updateLevel(items.length);
            var container = document.getElementById('logContainer');
            container.innerHTML = "";
            
            items.forEach(function(it) {
                var div = document.createElement('div');
                div.className = "log-item";
                div.innerHTML = 
                    "<span class='source-tag tag-local'>LOCAL</span>" +
                    "<div style='display:flex; justify-content:space-between;'><b>ğŸ“… " + it.date + "</b><span>" + it.knee + "</span></div>" +
                    (it.img ? '<img src="'+it.img+'" class="log-img">' : '') +
                    "<p style='color:#ddd;'>" + (it.note || "") + "</p>" +
                    "<div style='font-size:0.8rem; color:#888;'>ğŸ’¤ " + it.sleep + " | âš–ï¸ " + it.weight + "kg</div>";
                container.appendChild(div);
            });
            drawChart(items);
        }

        function updateLevel(count) {
            var lv = Math.floor(count / 5) + 1;
            document.getElementById('lvDisplay').innerHTML = "Lv." + lv + " é¨å£«";
            document.getElementById('xpBar').style.width = (count % 5) * 20 + "%";
        }

        function processForm() {
            var btn = document.getElementById('subBtn');
            btn.innerText = "ä¸Šå‚³ä¸­...";
            btn.disabled = true;

            var file = document.getElementById('f_img_file').files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var img = new Image();
                    img.onload = function() {
                        var canvas = document.createElement('canvas');
                        var ctx = canvas.getContext('2d');
                        var maxDim = 450;
                        var w = img.width; var h = img.height;
                        if (w > h) { if (w > maxDim) { h *= maxDim/w; w = maxDim; } } 
                        else { if (h > maxDim) { w *= maxDim/h; h = maxDim; } }
                        canvas.width = w; canvas.height = h;
                        ctx.drawImage(img, 0, 0, w, h);
                        saveData(canvas.toDataURL('image/jpeg', 0.6));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                saveData("");
            }
        }

        function saveData(imgData) {
            var entry = {
                date: document.getElementById('f_date').value,
                knee: document.getElementById('f_knee').value,
                sleep: document.getElementById('f_sleep').value,
                weight: document.getElementById('f_weight').value,
                note: document.getElementById('f_note').value,
                img: imgData
            };

            // 1. æœ¬æ©Ÿå­˜æª” (ç«‹å³å›é¥‹)
            var raw = localStorage.getItem(LOCAL_KEY);
            var items = raw ? JSON.parse(raw) : [];
            items.unshift(entry);
            localStorage.setItem(LOCAL_KEY, JSON.stringify(items));
            renderLocal(); // å…ˆé¡¯ç¤ºæœ¬æ©Ÿï¼Œè®“ä½¿ç”¨è€…è¦ºå¾—å¾ˆå¿«

            // 2. é›²ç«¯ä¸Šå‚³
            if (GAS_URL && GAS_URL.startsWith("http")) {
                fetch(GAS_URL, {
                    method: "POST",
                    headers: { "Content-Type": "text/plain;charset=utf-8" }, // iPhone ä¿®æ­£
                    body: JSON.stringify(entry)
                })
                .then(res => res.json())
                .then(data => {
                    alert("âœ… åŒæ­¥æˆåŠŸï¼");
                    resetForm();
                    fetchCloudData(); // ä¸Šå‚³å®Œå¾Œï¼Œé‡æ–°æŠ“ä¸€æ¬¡æœ€æ–°çš„é›²ç«¯è³‡æ–™ä¾†é¡¯ç¤º
                })
                .catch(err => {
                    alert("âš ï¸ å·²å­˜å…¥æœ¬æ©Ÿï¼Œä½†é›²ç«¯é€£ç·šå¤±æ•—");
                    resetForm();
                });
            } else {
                alert("âœ… å·²å­˜å…¥æœ¬æ©Ÿ");
                resetForm();
            }
        }

        function resetForm() {
            document.getElementById('mainForm').reset();
            document.getElementById('f_date').value = new Date().toISOString().substr(0, 10);
            var btn = document.getElementById('subBtn');
            btn.innerText = "ç¢ºèªç´€éŒ„";
            btn.disabled = false;
        }

        function drawChart(items) {
            if (typeof Chart === "undefined") return;
            var ctx = document.getElementById('chartCanvas').getContext('2d');
            var existingChart = Chart.getChart("chartCanvas");
            if (existingChart) existingChart.destroy();

            var d = items.slice().reverse().slice(-7);
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: d.map(function(x){ return x.date.substr(5); }),
                    datasets: [
                        { label: 'ç¡çœ ', data: d.map(function(x){ return x.sleep; }), borderColor: '#39ff14', borderWidth: 2, tension: 0.1 },
                        { label: 'é«”é‡', data: d.map(function(x){ return x.weight; }), borderColor: '#00f2ff', borderWidth: 2, tension: 0.1 }
                    ]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: { y: { grid: { color: '#333' } }, x: { grid: { display: false } } }, 
                    plugins: { legend: { labels: { color: '#fff' } } } 
                }
            });
        }
    </script>
</body>
</html>
