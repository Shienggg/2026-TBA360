<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    
    <meta http-equiv="Content-Security-Policy" content="default-src * 'self' data: blob: 'unsafe-inline' 'unsafe-eval'; script-src * 'self' data: blob: 'unsafe-inline' 'unsafe-eval';">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>TBA360 æˆ°æƒ…å®¤ v14</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #000; color: #fff; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; padding-top: 50px; min-height: 100vh; margin: 0; }
        .pixel-box { border: 2px solid #fff; padding: 20px; margin-bottom: 20px; width: 100%; max-width: 500px; background: #111; border-radius: 12px; box-sizing: border-box; }
        .timer-val { font-size: 3rem; color: #39ff14; text-align: center; margin: 10px 0; font-weight: bold; }
        .xp-bg { width: 100%; height: 12px; background: #333; border-radius: 6px; margin-bottom: 10px; overflow: hidden; }
        #xpBar { height: 100%; background: #00f2ff; width: 0%; transition: 0.5s; }
        input, select, textarea { width: 100%; background: #222; border: 1px solid #555; color: #fff; padding: 12px; margin-top: 10px; border-radius: 8px; box-sizing: border-box; font-size: 16px;}
        button { width: 100%; margin-top: 15px; padding: 15px; background: #fff; color: #000; border: none; font-weight: bold; font-size: 1.1rem; border-radius: 8px; }
        .log-item { border: 1px solid #333; padding: 15px; margin-top: 10px; background: #1a1a1a; border-radius: 8px; }
        .log-img { width: 100%; max-height: 300px; object-fit: cover; border-radius: 6px; margin: 10px 0; }
        .status-dot { height: 10px; width: 10px; background-color: #555; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-active { background-color: #39ff14; box-shadow: 0 0 5px #39ff14; }
    </style>
</head>
<body>

    <div class="pixel-box">
        <div style="display:flex; justify-content:space-between;">
            <span id="lvDisplay" style="color:#00f2ff; font-weight:bold;">Lv.1 é¨å£«</span>
            <span>2026/11/13 ç›®æ¨™</span>
        </div>
        <div class="xp-bg"><div id="xpBar"></div></div>
        <div class="timer-val" id="timerDisp">---</div>
        <div style="text-align:center; font-size:0.8rem; color:#aaa;">
            <span id="cloudStatus" class="status-dot"></span><span id="cloudText">å–®æ©Ÿæ¨¡å¼</span>
        </div>
    </div>

    <div class="pixel-box">
        <h2 style="margin-top:0; border-bottom:1px solid #333; padding-bottom:10px;">â¤ å¯«å…¥ç´€éŒ„</h2>
        <form id="mainForm">
            <input type="date" id="f_date" required>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <select id="f_knee">
                    <option value="ğŸŸ¢èˆ’æœ">ğŸŸ¢ èˆ’æœ</option>
                    <option value="ğŸŸ¡å¾®é…¸">ğŸŸ¡ å¾®é…¸</option>
                    <option value="ğŸ”´ç–¼ç—›">ğŸ”´ ç–¼ç—›</option>
                </select>
                <input type="number" id="f_sleep" placeholder="ç¡çœ  (0-100)">
            </div>
            <input type="number" id="f_weight" step="0.1" placeholder="é«”é‡ (kg)">
            <div style="margin-top:10px; border:1px dashed #444; padding:10px; border-radius:8px;">
                <label for="f_img_file" style="color:#aaa; font-size:0.9rem;">ğŸ“¸ åœ–ç‰‡ (è‡ªå‹•å£“ç¸®)</label>
                <input type="file" id="f_img_file" accept="image/*" style="margin-top:5px;">
            </div>
            <textarea id="f_note" placeholder="å¿ƒå¾—..." rows="3"></textarea>
            <button type="submit" id="subBtn">ç¢ºèªç´€éŒ„</button>
        </form>
    </div>

    <div class="pixel-box">
        <canvas id="chartCanvas" height="200"></canvas>
    </div>

    <div class="pixel-box">
        <h2 style="margin-top:0;">â¤ æ­·å²ç´€éŒ„ (æœ¬æ©Ÿ)</h2>
        <div id="logContainer"></div>
    </div>

    <script>
        // ==========================================
        // â–¼â–¼â–¼ æŠŠä½ çš„ Google Apps Script ç¶²å€è²¼åœ¨ä¸‹é¢å¼•è™Ÿå…§ â–¼â–¼â–¼
        var GAS_URL = "https://script.google.com/macros/s/AKfycbxjbykUNcsRwXiHqNVQ8JjjgDQ2YpDG4CFgiMxrb6mdypln84A3rtHvXy7BoJAwxn9S/exec"; 
        // ==========================================

        var LOCAL_KEY = "TBA360_V14_FINAL";

        try {
            var target = new Date(2026, 10, 13).getTime();
            var diff = target - new Date().getTime();
            var days = Math.floor(diff / (1000 * 60 * 60 * 24));
            document.getElementById('timerDisp').innerHTML = (days > 0 ? days : 0) + "<span style='font-size:1rem; color:#fff'> DAYS</span>";
        } catch(e) {}

        window.onload = function() {
            var today = new Date();
            document.getElementById('f_date').value = today.toISOString().substr(0, 10);
            
            if (GAS_URL && GAS_URL.startsWith("http")) {
                document.getElementById('cloudStatus').classList.add('status-active');
                document.getElementById('cloudText').innerText = "é›²ç«¯é€£ç·šå°±ç·’";
            }

            render();

            document.getElementById('mainForm').onsubmit = function(e) {
                e.preventDefault();
                processForm();
            };
        };

        function processForm() {
            var btn = document.getElementById('subBtn');
            btn.innerText = "è™•ç†ä¸­...";
            btn.disabled = true;

            var file = document.getElementById('f_img_file').files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var img = new Image();
                    img.onload = function() {
                        var canvas = document.createElement('canvas');
                        var ctx = canvas.getContext('2d');
                        var maxDim = 450;
                        var w = img.width; var h = img.height;
                        if (w > h) { if (w > maxDim) { h *= maxDim/w; w = maxDim; } } 
                        else { if (h > maxDim) { w *= maxDim/h; h = maxDim; } }
                        canvas.width = w; canvas.height = h;
                        ctx.drawImage(img, 0, 0, w, h);
                        saveData(canvas.toDataURL('image/jpeg', 0.6));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                saveData("");
            }
        }

        function saveData(imgData) {
            var entry = {
                date: document.getElementById('f_date').value,
                knee: document.getElementById('f_knee').value,
                sleep: document.getElementById('f_sleep').value,
                weight: document.getElementById('f_weight').value,
                note: document.getElementById('f_note').value,
                img: imgData
            };

            // 1. æœ¬æ©Ÿå­˜æª”
            try {
                var raw = localStorage.getItem(LOCAL_KEY);
                var items = raw ? JSON.parse(raw) : [];
                items.unshift(entry);
                localStorage.setItem(LOCAL_KEY, JSON.stringify(items));
                
                try { render(); } catch(err) { console.error("Chart Error ignored"); }
                
            } catch(e) {
                alert("æœ¬æ©Ÿå­˜æª”å¤±æ•—");
            }

            // 2. é›²ç«¯ä¸Šå‚³
            if (GAS_URL && GAS_URL.startsWith("http")) {
                fetch(GAS_URL, {
                    method: "POST",
                    body: JSON.stringify(entry)
                })
                .then(res => res.json())
                .then(data => {
                    alert("âœ… æœ¬æ©Ÿ + â˜ï¸ é›²ç«¯åŒæ­¥æˆåŠŸï¼");
                    resetForm();
                })
                .catch(err => {
                    alert("âœ… æœ¬æ©ŸæˆåŠŸï¼Œä½† âš ï¸ é›²ç«¯å¤±æ•— (è«‹æª¢æŸ¥ç¶²å€)");
                    resetForm();
                });
            } else {
                alert("âœ… æœ¬æ©Ÿå„²å­˜æˆåŠŸ");
                resetForm();
            }
        }

        function resetForm() {
            document.getElementById('mainForm').reset();
            document.getElementById('f_date').value = new Date().toISOString().substr(0, 10);
            var btn = document.getElementById('subBtn');
            btn.innerText = "ç¢ºèªç´€éŒ„";
            btn.disabled = false;
        }

        function render() {
            var raw = localStorage.getItem(LOCAL_KEY);
            var items = raw ? JSON.parse(raw) : [];
            
            var container = document.getElementById('logContainer');
            container.innerHTML = items.length ? "" : "<p style='text-align:center; color:#555;'>æš«ç„¡ç´€éŒ„</p>";
            var lv = Math.floor(items.length / 5) + 1;
            document.getElementById('lvDisplay').innerHTML = "Lv." + lv + " é¨å£«";
            document.getElementById('xpBar').style.width = (items.length % 5) * 20 + "%";

            items.forEach(function(it) {
                var div = document.createElement('div');
                div.className = "log-item";
                div.innerHTML = "<div style='display:flex; justify-content:space-between;'><b>ğŸ“… " + it.date + "</b><span>" + it.knee + "</span></div>" +
                    (it.img ? '<img src="'+it.img+'" class="log-img">' : '') +
                    "<p style='color:#ddd;'>" + (it.note || "") + "</p>" +
                    "<div style='font-size:0.8rem; color:#888;'>ğŸ’¤ " + it.sleep + " | âš–
