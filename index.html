<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Security-Policy" content="default-src * 'self' data: blob: 'unsafe-inline' 'unsafe-eval';">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>TBA360 v21 Diagnostic</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>
body{background:#000;color:#fff;font-family:-apple-system,sans-serif;display:flex;flex-direction:column;align-items:center;margin:0;padding-bottom:40px}
.banner-container{width:100%;height:200px;overflow:hidden;position:relative;border-bottom:4px solid #00f2ff;margin-bottom:20px;background:#111}
.banner-img{width:100%;height:100%;object-fit:cover;object-position:center;opacity:0.9}
.banner-title{position:absolute;bottom:10px;left:20px;font-size:2rem;font-weight:bold;color:#fff;text-shadow:0 0 10px #00f2ff;background:rgba(0,0,0,0.6);padding:5px 15px;border-radius:5px;border:1px solid #00f2ff}
.pixel-box{border:2px solid #fff;padding:20px;margin-bottom:20px;width:90%;max-width:500px;background:#111;border-radius:12px;box-sizing:border-box}
.cp-value{font-size:3.5rem;color:#ff3131;font-weight:900;text-shadow:0 0 15px #ff0000;font-family:monospace;text-align:center}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
.stat-card{background:#222;padding:10px;border-radius:8px;text-align:center;border:1px solid #444}
.stat-val{font-size:1.2rem;color:#39ff14;font-weight:bold}
.timer-val{font-size:1.5rem;color:#39ff14;text-align:center;margin-top:5px}
.xp-bg{width:100%;height:8px;background:#333;border-radius:4px;margin:10px 0;overflow:hidden}
#xpBar{height:100%;background:#00f2ff;width:0%;transition:0.5s}
input,select,textarea{width:100%;background:#222;border:1px solid #555;color:#fff;padding:12px;margin-top:10px;border-radius:8px;box-sizing:border-box;font-size:16px;-webkit-appearance:none}
button{width:100%;margin-top:15px;padding:15px;background:#fff;color:#000;border:none;font-weight:bold;font-size:1.1rem;border-radius:8px}
.log-item{border:1px solid #333;padding:15px;margin-top:10px;background:#1a1a1a;border-radius:8px;position:relative}
.log-img{width:100%;max-height:300px;object-fit:cover;border-radius:6px;margin:10px 0}
.tag-type{position:absolute;top:10px;right:10px;font-size:0.7rem;background:#004444;color:#00f2ff;padding:2px 8px;border-radius:10px;border:1px solid #00f2ff}
#loading-indicator{text-align:center;color:#00f2ff;font-size:0.9rem;margin:10px 0;display:none}
</style>
</head>
<body>

<div class="banner-container">
<img src="" class="banner-img" id="bannerImg" onerror="this.src='https://via.placeholder.com/800x450/000033/00f2ff?text=Loading...'">
<div class="banner-title">TBA360 æˆ°æƒ…å®¤</div>
</div>

<div class="pixel-box">
<div style="text-align:center;margin-bottom:15px"><span style="font-size:0.9rem;color:#aaa;letter-spacing:2px">CURRENT CP / æˆ°é¬¥åŠ›</span><div class="cp-value" id="cpVal">0</div></div>
<div class="stats-grid">
<div class="stat-card"><div class="stat-val" id="totalDist">0 km</div><div style="font-size:0.7rem;color:#888">ç´¯ç©é‡Œç¨‹</div></div>
<div class="stat-card"><div class="stat-val" id="totalTime">0 h</div><div style="font-size:0.7rem;color:#888">ç´¯ç©æ™‚æ•¸</div></div>
<div class="stat-card"><div class="stat-val" id="totalCal">0</div><div style="font-size:0.7rem;color:#888">ç‡ƒç‡’ç†±é‡</div></div>
<div class="stat-card"><div class="stat-val" id="totalCount">0</div><div style="font-size:0.7rem;color:#888">å‡ºå‹¤æ¬¡æ•¸</div></div>
</div>
<div style="display:flex;justify-content:space-between;margin-top:15px">
<span id="lvDisplay" style="color:#00f2ff;font-weight:bold">Lv.1 é¨å£«</span>
<div class="timer-val" id="timerDisp">---</div>
</div>
<div class="xp-bg"><div id="xpBar"></div></div>
</div>

<div class="pixel-box">
<h2 style="margin-top:0;border-bottom:1px solid #333;padding-bottom:10px">â¤ å¯«å…¥ç´€éŒ„</h2>
<form id="mainForm">
<input type="date" id="f_date" required>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
<select id="f_type">
<option value="ğŸš´ é¨è¡Œ">ğŸš´ é¨è¡Œ</option><option value="ğŸš¶ å¿«èµ°">ğŸš¶ å¿«èµ°</option><option value="ğŸƒ è·‘æ­¥">ğŸƒ è·‘æ­¥</option>
<option value="ğŸ€ æ‰“çƒ">ğŸ€ æ‰“çƒ</option><option value="ğŸ‹ï¸ é‡è¨“">ğŸ‹ï¸ é‡è¨“</option><option value="ğŸ§˜ ä¼¸å±•">ğŸ§˜ ä¼¸å±•</option><option value="ğŸ›Œ ä¼‘æ¯">ğŸ›Œ ä¼‘æ¯</option>
</select>
<select id="f_knee"><option value="ğŸŸ¢èˆ’æœ">ğŸŸ¢ è†è“‹èˆ’æœ</option><option value="ğŸŸ¡å¾®é…¸">ğŸŸ¡ è†è“‹å¾®é…¸</option><option value="ğŸ”´ç–¼ç—›">ğŸ”´ è†è“‹ç–¼ç—›</option></select>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px">
<input type="number" id="f_dist" placeholder="è·é›¢(km)" step="0.1"><input type="number" id="f_time" placeholder="æ™‚é–“(hr)" step="0.1"><input type="number" id="f_cal" placeholder="å¡è·¯é‡Œ" step="1">
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
<input type="number" id="f_sleep" placeholder="ç¡çœ  (0-100)"><input type="number" id="f_weight" step="0.1" placeholder="é«”é‡ (kg)">
</div>
<div style="margin-top:10px;border:1px dashed #444;padding:10px;border-radius:8px">
<label for="f_img_file" style="color:#aaa;font-size:0.9rem">ğŸ“¸ åœ–ç‰‡</label>
<input type="file" id="f_img_file" accept="image/*" style="margin-top:5px">
</div>
<textarea id="f_note" placeholder="å¿ƒå¾—..." rows="2"></textarea>
<button type="submit" id="subBtn">ç¢ºèªç´€éŒ„</button>
</form>
</div>

<div class="pixel-box"><canvas id="chartCanvas" height="200"></canvas></div>
<div class="pixel-box">
<h2 style="margin-top:0">â¤ æ­·å²ç´€éŒ„</h2>
<div id="loading-indicator">â˜ï¸ åŒæ­¥ä¸­...</div>
<div id="logContainer"></div>
</div>

<script>
// â–¼â–¼â–¼ éŒ¯èª¤æ””æˆªå™¨ â–¼â–¼â–¼
window.onerror = function(msg, url, line) {
alert("âŒ ç™¼ç”ŸéŒ¯èª¤:\n" + msg + "\nè¡Œæ•¸: " + line);
return false;
};
// â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

var GAS_URL = "https://script.google.com/macros/s/AKfycbxjbykUNcsRwXiHqNVQ8JjjgDQ2YpDG4CFgiMxrb6mdypln84A3rtHvXy7BoJAwxn9S/exec";
var BANNER_URL = "https://i.meee.com.tw/0neg3F9.png";
var LOCAL_KEY = "TBA360_V21_DIAG";
var myChart = null;

window.onload = function() {
if(BANNER_URL) { var b=document.getElementById('bannerImg'); if(b) b.src = BANNER_URL; }
initApp();
};

function initApp() {
var today = new Date();
document.getElementById('f_date').value = today.toISOString().substr(0, 10);
try {
var target = new Date(2026, 10, 13).getTime();
var diff = target - new Date().getTime();
var days = Math.floor(diff / (1000 * 60 * 60 * 24));
document.getElementById('timerDisp').innerHTML = (days > 0 ? days : 0) + "<span style='font-size:0.8rem;color:#fff'> DAYS LEFT</span>";
} catch(e) {}

renderLocal();

if (GAS_URL && GAS_URL.startsWith("http")) {
fetchCloudData();
}

document.getElementById('subBtn').onclick = function(e) {
e.preventDefault();
processForm();
};
}

function fetchCloudData() {
document.getElementById('loading-indicator').style.display = 'block';
fetch(GAS_URL)
.then(function(res){ return res.json(); })
.then(function(data){
document.getElementById('loading-indicator').style.display = 'none';
if (data && data.length > 0) renderCloud(data);
})
.catch(function(err){
document.getElementById('loading-indicator').style.display = 'none';
console.log(err);
});
}

function renderCloud(items) {
updateStatsAndCP(items);
renderList(items, "CLOUD");
}

function renderLocal() {
var raw = localStorage.getItem(LOCAL_KEY);
var items = raw ? JSON.parse(raw) : [];
updateStatsAndCP(items);
renderList(items, "LOCAL");
}

function updateStatsAndCP(items) {
var totalDist = 0; var totalTime = 0; var totalCal = 0; var count = 0;
var currentWeight = 80; var currentSleep = 60;

if (items.length > 0) {
if (items[0].weight) currentWeight = parseFloat(items[0].weight);
if (items[0].sleep) currentSleep = parseFloat(items[0].sleep);
}

items.forEach(function(it) {
if (it.type !== "ğŸ›Œ ä¼‘æ¯") {
count++;
totalDist += parseFloat(it.dist || 0);
totalTime += parseFloat(it.time || 0);
totalCal += parseFloat(it.cal || 0);
}
});

document.getElementById('totalDist').innerText = totalDist.toFixed(1) + " km";
document.getElementById('totalTime').innerText = totalTime.toFixed(1) + " h";
document.getElementById('totalCal').innerText = totalCal;
document.getElementById('totalCount').innerText = count;

var lv = Math.floor(count / 5) + 1;
document.getElementById('lvDisplay').innerHTML = "Lv." + lv + " é¨å£«";
document.getElementById('xpBar').style.width = (count % 5) * 20 + "%";

var base = totalDist + totalTime + totalCal;
var weightBonus = (80 - currentWeight) * 10;
var sleepBonus = currentSleep / 60;
var multiplier = 1 + (count + weightBonus + sleepBonus + count) / 100;
var cp = Math.floor(base * multiplier);

document.getElementById('cpVal').innerText = cp.toLocaleString();
}

function renderList(items, source) {
var container = document.getElementById('logContainer');
container.innerHTML = "";
items.forEach(function(it) {
var div = document.createElement('div');
div.className = "log-item";
div.innerHTML = 
"<span class='tag-type'>" + (it.type || "ç´€éŒ„") + "</span>" +
"<div style='display:flex;justify-content:space-between'><b>ğŸ“… " + it.date + "</b><span>" + it.knee + "</span></div>" +
(it.img ? '<img src="'+it.img+'" class="log-img">' : '') +
"<div style='font-size:0.9rem;margin:5px 0;color:#00f2ff'>" + 
(it.dist>0 ? it.dist+"km " : "") + 
(it.time>0 ? it.time+"h " : "") + 
(it.cal>0 ? "ğŸ”¥"+it.cal : "") + 
"</div>" +
"<p style='color:#ddd;font-size:0.9rem'>" + (it.note || "") + "</p>" +
"<div style='font-size:0.8rem;color:#888'>ğŸ’¤ " + it.sleep + " | âš–ï¸ " + it.weight + "kg</div>";
container.appendChild(div);
});
drawChart(items);
}

function processForm() {
var btn = document.getElementById('subBtn');
btn.innerText = "ä¸Šå‚³ä¸­...";
btn.disabled = true;

var file = document.getElementById('f_img_file').files[0];
if (file) {
var reader = new FileReader();
reader.onload = function(e) {
var img = new Image();
img.onload = function() {
var canvas = document.createElement('canvas');
var ctx = canvas.getContext('2d');
var maxDim = 450;
var w = img.width; var h = img.height;
if (w > h) { if (w > maxDim) { h *= maxDim/w; w = maxDim; } } 
else { if (h > maxDim) { w *= maxDim/h; h = maxDim; } }
canvas.width = w; canvas.height = h;
ctx.drawImage(img, 0, 0, w, h);
saveData(canvas.toDataURL('image/jpeg', 0.6));
};
img.src = e.target.result;
};
reader.readAsDataURL(file);
} else {
saveData("");
}
}

function saveData(imgData) {
var entry = {
date: document.getElementById('f_date').value,
type: document.getElementById('f_type').value,
knee: document.getElementById('f_knee').value,
dist: document.getElementById('f_dist').value,
time: document.getElementById('f_time').value,
cal: document.getElementById('f_cal').value,
sleep: document.getElementById('f_sleep').value,
weight: document.getElementById('f_weight').value,
note: document.getElementById('f_note').value,
img: imgData
};

var raw = localStorage.getItem(LOCAL_KEY);
var items = raw ? JSON.parse(raw) : [];
items.unshift(entry);
localStorage.setItem(LOCAL_KEY, JSON.stringify(items));
renderLocal(); 

if (GAS_URL && GAS_URL.startsWith("http")) {
fetch(GAS_URL, {
method: "POST",
headers: { "Content-Type": "text/plain;charset=utf-8" },
body: JSON.stringify(entry)
})
.then(function(res){ return res.json(); })
.then(function(data){
alert("âœ… æˆ°é¬¥åŠ›å·²æ›´æ–°ï¼");
resetForm();
fetchCloudData(); 
})
.catch(function(err){
alert("âš ï¸ æœ¬æ©Ÿå·²å­˜ï¼Œé›²ç«¯å¤±æ•—");
resetForm();
});
} else {
alert("âœ… æœ¬æ©Ÿå·²å­˜");
resetForm();
}
}

function resetForm() {
document.getElementById('mainForm').reset();
document.getElementById('f_date').value = new Date().toISOString().substr(0, 10);
var btn = document.getElementById('subBtn');
btn.innerText = "ç¢ºèªç´€éŒ„";
btn.disabled = false;
}

function drawChart(items) {
if (typeof Chart === "undefined") return;
var ctx = document.getElementById('chartCanvas').getContext('2d');
if (myChart) myChart.destroy();

var d = items.slice().reverse().slice(-7);
myChart = new Chart(ctx, {
type: 'line',
data: {
labels: d.map(function(x){ return x.date.substr(5); }),
datasets: [
{ label: 'é«”é‡', data: d.map(function(x){ return x.weight; }), borderColor: '#00f2ff', borderWidth: 2, tension: 0.1 },
{ label: 'ç¡çœ ', data: d.map(function(x){ return x.sleep; }), borderColor: '#39ff14', borderWidth: 2, tension: 0.1 }
]
},
options: { 
responsive: true, 
maintainAspectRatio: false,
scales: { y: { grid: { color: '#333' } }, x: { grid: { display: false } } }, 
plugins: { legend: { labels: { color: '#fff' } } } 
}
});
}
</script>
</body>
</html>
